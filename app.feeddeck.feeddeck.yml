app-id: app.feeddeck.feeddeck
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
command: feeddeck

finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --socket=pulseaudio
  - --device=dri
  - --share=network
  - --filesystem=xdg-documents

modules:
  - name: FeedDeck
    buildsystem: simple
    build-commands:
      - cp -R bundle /app/feeddeck
      - mkdir -p /app/bin && ln -s /app/feeddeck/feeddeck /app/bin/feeddeck
      - chmod +x /app/bin/feeddeck
      - install -Dm644 /app/feeddeck/app.feeddeck.feeddeck.svg /app/share/icons/hicolor/scalable/apps/app.feeddeck.feeddeck.svg
      - install -Dm644 /app/feeddeck/app.feeddeck.feeddeck.desktop -t /app/share/applications/
      - install -Dm644 /app/feeddeck/app.feeddeck.feeddeck.metainfo.xml -t /app/share/metainfo/
    sources:
      - type: archive
        only-arches:
          - x86_64
        url: https://github.com/feeddeck/feeddeck/releases/download/v1.2.0/feeddeck-linux-x86_64.tar.gz
        sha256: 809a60f74d82313e27667f343a44e187280190acd8b4b1f4d0ae6c8203809015
        dest: bundle
      - type: archive
        only-arches:
          - aarch64
        url: https://github.com/feeddeck/feeddeck/releases/download/v1.2.0/feeddeck-linux-arm64.tar.gz
        sha256: c23d31c9c00929d6e0202da9c746b8ed53bdd37836ae873fe53786784fdac67f
        dest: bundle

    modules:
      - name: libmpv
        cleanup:
          - /include
          - /lib/pkgconfig
          - /share/man
        buildsystem: simple
        build-commands:
          - python3 waf configure --prefix=/app --enable-libmpv-shared --disable-cplayer
            --disable-build-date --disable-alsa
          - python3 waf build
          - python3 waf install
        sources:
          - type: git
            url: https://github.com/mpv-player/mpv.git
            tag: v0.35.1
          - type: file
            url: https://waf.io/waf-2.0.25
            sha256: 21199cd220ccf60434133e1fd2ab8c8e5217c3799199c82722543970dc8e38d5
            dest-filename: waf

        modules:
          - name: luajit
            no-autogen: true
            cleanup:
              - /bin
              - /include
              - /lib/pkgconfig
              - /share/man
            sources:
              - type: git
                url: https://github.com/LuaJIT/LuaJIT.git
                mirror-urls:
                  - https://luajit.org/git/luajit.git
                disable-shallow-clone: true
                commit: 43d0a19158ceabaa51b0462c1ebc97612b420a2e
                x-checker-data:
                  type: json
                  url: https://api.github.com/repos/LuaJIT/LuaJIT/commits
                  commit-query: first( .[].sha )
                  version-query: first( .[].sha )
                  timestamp-query: first( .[].commit.committer.date )
              - type: shell
                commands:
                  - sed -i 's|/usr/local|/app|' ./Makefile

          - name: uchardet
            buildsystem: cmake-ninja
            config-opts:
              - -DCMAKE_BUILD_TYPE=Release
              - -DBUILD_STATIC=0
            cleanup:
              - /bin
              - /include
              - /lib/pkgconfig
              - /share/man
            sources:
              - type: archive
                url: https://www.freedesktop.org/software/uchardet/releases/uchardet-0.0.8.tar.xz
                sha256: e97a60cfc00a1c147a674b097bb1422abd9fa78a2d9ce3f3fdcc2e78a34ac5f0
                x-checker-data:
                  type: html
                  url: https://www.freedesktop.org/software/uchardet/releases/
                  version-pattern: uchardet-(\d\.\d+\.?\d*).tar.xz
                  url-template: https://www.freedesktop.org/software/uchardet/releases/uchardet-$version.tar.xz

          - name: libass
            cleanup:
              - /include
              - /lib/pkgconfig
            config-opts:
              - --disable-static
            sources:
              - type: git
                url: https://github.com/libass/libass.git
                tag: 0.17.1
                commit: e8ad72accd3a84268275a9385beb701c9284e5b3
                x-checker-data:
                  type: git
                  tag-pattern: ^(\d\.\d{1,3}\.\d{1,2})$

          - name: libv4l2
            buildsystem: meson
            cleanup:
              - /include
              - /lib/pkgconfig
              - /share/man
            config-opts:
              - -Ddoxygen-html=false
              - -Ddoxygen-doc=disabled
              - -Dbpf=disabled
              - -Dudevdir=/app/lib/udev
            sources:
              - type: git
                url: https://git.linuxtv.org/v4l-utils.git
                mirror-urls:
                  - https://github.com/gjasny/v4l-utils.git
                tag: v4l-utils-1.26.0
                commit: b5467f9bd5b799051fd42b4a5c8808a37e70c429
                x-checker-data:
                  type: git
                  tag-pattern: ^v4l-utils-([\d.]+)$

          - name: nv-codec-headers
            cleanup:
              - '*'
            no-autogen: true
            make-install-args:
              - PREFIX=/app
            sources:
              - type: git
                url: https://github.com/FFmpeg/nv-codec-headers.git
                mirror-urls:
                  - https://git.videolan.org/git/ffmpeg/nv-codec-headers.git
                tag: n12.1.14.0
                commit: 1889e62e2d35ff7aa9baca2bceb14f053785e6f1
                x-checker-data:
                  type: git
                  tag-pattern: ^n([\d.]+)$

          - name: x264
            cleanup:
              - /include
              - /lib/pkgconfig
              - /share/man
            config-opts:
              - --disable-cli
              - --enable-shared
            sources:
              - type: git
                url: https://code.videolan.org/videolan/x264.git
                commit: c196240409e4d7c01b47448d93b1f9683aaa7cf7
                # Every commit to the master branch is considered a release
                # https://code.videolan.org/videolan/x264/-/issues/35
                x-checker-data:
                  type: json
                  url: https://code.videolan.org/api/v4/projects/536/repository/commits
                  commit-query: first( .[].id )
                  version-query: first( .[].id )
                  timestamp-query: first( .[].committed_date )

          - name: ffmpeg
            cleanup:
              - /include
              - /lib/pkgconfig
              - /share/ffmpeg/examples
            config-opts:
              - --disable-debug
              - --disable-doc
              - --disable-static
              - --enable-encoder=png
              - --enable-gnutls
              - --enable-gpl
              - --enable-shared
              - --enable-version3
              - --enable-libaom
              - --enable-libass
              - --enable-libdav1d
              - --enable-libfreetype
              - --enable-libmp3lame
              - --enable-libopus
              - --enable-libtheora
              - --enable-libv4l2
              - --enable-libvorbis
              - --enable-libvpx
              - --enable-libx264
              - --enable-libwebp
            sources:
              - type: git
                url: https://github.com/FFmpeg/FFmpeg.git
                mirror-urls:
                  - https://git.ffmpeg.org/ffmpeg.git
                commit: d4ff0020b40b524a490cf62eccbd3a318f4c0e58
                tag: n6.1
                x-checker-data:
                  type: git
                  tag-pattern: ^n([\d.]{3,7})$
